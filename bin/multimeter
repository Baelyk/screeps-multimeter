#!/usr/bin/env node

const ScreepsAPI = require('screeps-api')
const blessed = require('blessed');
const path = require('path');
const fs = require('fs');
const homedir = require('homedir');
const MainView = require('../src/main_view');

function load_config() {
  let home = homedir();
  let paths = [
    path.resolve('./multimeter.config.js'),
    path.resolve(home, '.config/multimeter.config.js'),
    path.resolve(home, '.multimeter.config.js'),
  ];
  for (var i = 0; i < paths.length; i++) {
    if (fs.existsSync(paths[i])) {
      return require(paths[i]);
    }
  }
  return {};
}

const config = load_config();

const MOTD = "Now showing Screeps console. Type /help for help.";

console.log("Connecting to Screens...");
Promise.resolve(connect())
  .then(start)
  .catch((ex) => {
    screen.destroy();
    console.error(ex);
    process.exit(1);
  });

function connect() {
  return new Promise((resolve, reject) => {
    let api = new ScreepsAPI();
    api.auth(config.email, config.password, (err, result) => {
      if (result) {
        resolve(api);
      } else {
        console.error('Authentication failed')
        reject(err);
      }
    })
  }).then((api) => new Promise((resolve, reject) => {
    api.socket();

    api.on('message', (msg) => {
      if (msg.slice(0, 7) == 'auth ok') {
        resolve(api);
      }
    })
  }));
}

function start(api) {
  return new Promise((resolve, reject) => {
    let screen = blessed.screen({
      smartCSR: true,
    });

    screen.title = "Screeps";

    let view = new MainView({
      parent: screen,
      top: 0,
      left: 0,
      width: screen.width,
      height: screen.height,
    });

    view.on('exit', () => {
      screen.destroy();
      process.exit(0);
    });

    view.setAPI(api);
    view.focus();
    view.log(MOTD);
  })
}
