#!/usr/bin/env node

const ScreepsAPI = require('screeps-api')
const configManager = require('../src/config_manager');
const nux = require('../src/nux');
const Multimeter = require('../src/multimeter');

Promise.resolve(loadConfig())
  .then(connect)
  .then(start)
  .catch((ex) => {
    console.error(ex);
    process.exit(1);
  });

function loadConfig() {
  return configManager.loadConfig()
    .then(([path, config]) => {
      if (path) return config;
      // No saved config, need to run the NUX.
      return nux().then(([path, config]) => config);
    });
}

function connect(config) {
  return new Promise((resolve, reject) => {
    console.log("Connecting to Screens...");
    let api = new ScreepsAPI();
    api.auth(config.email, config.password, (err, result) => {
      if (result) {
        resolve(api);
      } else {
        console.error('Authentication failed')
        reject(err);
      }
    })
  }).then((api) => new Promise((resolve, reject) => {
    api.socket();

    api.on('message', (msg) => {
      if (msg.slice(0, 7) == 'auth ok') {
        resolve(api);
      }
    })
  }));
}

function start(api) {
  var app = new Multimeter(api);
  return app.run();
}
